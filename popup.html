<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <style>
            body {
                width: 350px;
                padding: 16px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI',
                    Roboto, sans-serif;
                background: #f8f9fa;
            }

            .header {
                text-align: center;
                margin-bottom: 20px;
            }

            .header h1 {
                margin: 0;
                color: #1a73e8;
                font-size: 20px;
            }

            .header p {
                margin: 4px 0 0 0;
                color: #5f6368;
                font-size: 14px;
            }

            .section {
                background: white;
                border-radius: 8px;
                padding: 16px;
                margin-bottom: 16px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }

            .section h3 {
                margin: 0 0 12px 0;
                color: #202124;
                font-size: 16px;
            }

            .form-group {
                margin-bottom: 12px;
            }

            label {
                display: block;
                margin-bottom: 4px;
                color: #5f6368;
                font-size: 13px;
                font-weight: 500;
            }

            input {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #dadce0;
                border-radius: 4px;
                font-size: 14px;
                box-sizing: border-box;
            }

            input:focus {
                outline: none;
                border-color: #1a73e8;
                box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
            }

            button {
                width: 100%;
                padding: 10px;
                background: #1a73e8;
                color: white;
                border: none;
                border-radius: 4px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            button:hover {
                background: #1557b0;
            }

            button:disabled {
                background: #dadce0;
                cursor: not-allowed;
            }

            .status {
                margin-top: 12px;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 13px;
                text-align: center;
            }

            .status.success {
                background: #e8f5e8;
                color: #137333;
                border: 1px solid #c6e7c6;
            }

            .status.error {
                background: #fce8e6;
                color: #d93025;
                border: 1px solid #f5c6cb;
            }

            .status.warning {
                background: #fef7e0;
                color: #b06000;
                border: 1px solid #fce5b3;
            }

            .info {
                background: #e8f0fe;
                border: 1px solid #d2e3fc;
                border-radius: 4px;
                padding: 12px;
                font-size: 13px;
                color: #1557b0;
            }

            .info a {
                color: #1a73e8;
                text-decoration: none;
            }

            .info a:hover {
                text-decoration: underline;
            }

            .usage-stats {
                display: flex;
                justify-content: space-between;
                text-align: center;
                margin-top: 12px;
            }

            .stat {
                flex: 1;
            }

            .stat-number {
                font-size: 18px;
                font-weight: bold;
                color: #1a73e8;
            }

            .stat-label {
                font-size: 12px;
                color: #5f6368;
                margin-top: 4px;
            }
        </style>
    </head>
    <body>
        <div class="header">
            <h1>ðŸŽ¯ Gmail Intelligence</h1>
            <p>Prevent workplace miscommunications</p>
        </div>

        <!-- <div class="section">
            <h3>OpenAI API Configuration</h3>

            <div class="form-group">
                <label for="apiKey">API Key:</label>
                <input
                    type="password"
                    id="apiKey"
                    placeholder="sk-..."
                />
            </div>

            <button id="saveKey">Save API Key</button>

            <div id="status"></div>

            <div class="info">
                <strong>Don't have an API key?</strong><br />
                1. Visit
                <a
                    href="https://platform.openai.com/api-keys"
                    target="_blank"
                    >OpenAI API Keys</a
                ><br />
                2. Create a new secret key<br />
                3. Add billing information (required)<br />
                4. Paste the key above
            </div>
        </div> -->

        <div class="section">
            <h3>How it Works</h3>
            <p style="font-size: 13px; color: #5f6368; line-height: 1.4">
                1. Compose an email in Gmail.<br />
                2. Click the "ðŸŽ¯ Check Tone" button<br />
                3. Get instant sentiment analysis and suggestions<br />
                4. Improve your email before sending
            </p>

            <div style="margin-top: 16px">
                <button
                    id="testConnection"
                    style="background: #34a853; margin-bottom: 8px"
                >
                    ðŸ”— Test Backend Connection
                </button>
                <div
                    id="connectionStatus"
                    class="status"
                    style="display: none"
                ></div>
            </div>

            <!-- <div class="usage-stats">
                <div class="stat">
                    <div
                        class="stat-number"
                        id="emailsAnalyzed"
                    >
                        0
                    </div>
                    <div class="stat-label">Emails Analyzed</div>
                </div>
                <div class="stat">
                    <div
                        class="stat-number"
                        id="issuesFound"
                    >
                        0
                    </div>
                    <div class="stat-label">Issues Prevented</div>
                </div>
            </div> -->
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', async function () {
                const apiKeyInput = document.getElementById('apiKey');
                const saveButton = document.getElementById('saveKey');
                const statusDiv = document.getElementById('status');
                const testConnectionBtn =
                    document.getElementById('testConnection');
                const connectionStatusDiv =
                    document.getElementById('connectionStatus');

                // Load existing API key
                const result = await chrome.storage.sync.get([
                    'apiKey',
                    'emailsAnalyzed',
                    'issuesFound',
                ]);
                if (result.apiKey) {
                    apiKeyInput.value = result.apiKey;
                    showStatus('API key loaded', 'success');
                }

                // Update usage stats
                document.getElementById('emailsAnalyzed').textContent =
                    result.emailsAnalyzed || 0;
                document.getElementById('issuesFound').textContent =
                    result.issuesFound || 0;

                // Test backend connection
                testConnectionBtn.addEventListener('click', async function () {
                    testConnectionBtn.disabled = true;
                    testConnectionBtn.textContent = 'Testing...';
                    connectionStatusDiv.style.display = 'none';

                    try {
                        const response = await fetch(
                            'https://gmail-intelligence-backend.onrender.com/health',
                            {
                                method: 'GET',
                                mode: 'cors',
                                credentials: 'omit',
                            }
                        );

                        if (response.ok) {
                            showConnectionStatus(
                                'âœ… Backend is reachable and responding',
                                'success'
                            );
                        } else {
                            showConnectionStatus(
                                `âš ï¸ Backend responded with status ${response.status}`,
                                'warning'
                            );
                        }
                    } catch (error) {
                        console.error('Connection test failed:', error);
                        if (
                            error.name === 'TypeError' &&
                            error.message.includes('Failed to fetch')
                        ) {
                            showConnectionStatus(
                                'âŒ Network error: Unable to reach backend. Check your internet connection.',
                                'error'
                            );
                        } else if (error.message.includes('CORS')) {
                            showConnectionStatus(
                                'âŒ CORS error: Backend is not allowing requests from this extension.',
                                'error'
                            );
                        } else {
                            showConnectionStatus(
                                `âŒ Connection failed: ${error.message}`,
                                'error'
                            );
                        }
                    } finally {
                        testConnectionBtn.disabled = false;
                        testConnectionBtn.textContent =
                            'ðŸ”— Test Backend Connection';
                    }
                });

                // Save API key
                saveButton.addEventListener('click', async function () {
                    const apiKey = apiKeyInput.value.trim();

                    if (!apiKey) {
                        showStatus('Please enter your API key', 'error');
                        return;
                    }

                    if (!apiKey.startsWith('sk-')) {
                        showStatus('API key should start with "sk-"', 'error');
                        return;
                    }

                    saveButton.disabled = true;
                    saveButton.textContent = 'Testing...';

                    try {
                        // Test the API key
                        const testResponse = await fetch(
                            'https://api.openai.com/v1/models',
                            {
                                headers: {
                                    Authorization: `Bearer ${apiKey}`,
                                },
                            }
                        );

                        if (testResponse.ok) {
                            await chrome.storage.sync.set({ apiKey: apiKey });
                            showStatus(
                                'API key saved successfully!',
                                'success'
                            );
                        } else {
                            showStatus(
                                'Invalid API key. Please check and try again.',
                                'error'
                            );
                        }
                    } catch (error) {
                        showStatus(
                            'Error testing API key: ' + error.message,
                            'error'
                        );
                    } finally {
                        saveButton.disabled = false;
                        saveButton.textContent = 'Save API Key';
                    }
                });

                function showStatus(message, type) {
                    statusDiv.textContent = message;
                    statusDiv.className = `status ${type}`;
                    statusDiv.style.display = 'block';

                    if (type === 'success') {
                        setTimeout(() => {
                            statusDiv.style.display = 'none';
                        }, 3000);
                    }
                }

                function showConnectionStatus(message, type) {
                    connectionStatusDiv.textContent = message;
                    connectionStatusDiv.className = `status ${type}`;
                    connectionStatusDiv.style.display = 'block';
                }
            });
        </script>
    </body>
</html>
